<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Flappy Bird افقی حرفه‌ای</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden; height: 100%;
    background: #000;
    font-family: 'Vazir', sans-serif;
  }
  #gameCanvas {
    display: block;
    background: url('https://s6.uupload.ir/files/how-would-you-describe-this-angry-birds-background-v0-9rpwenf2y3nd1_0nx2.png') no-repeat center center;
    background-size: cover;
    width: 100vw;
    height: 100vh;
    touch-action: none;
    position: relative;
    z-index: 1;
  }
  #rotateScreen {
    position: fixed; bottom: 10px; right: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255,255,255,0.15);
    font-size: 12px; font-weight: 600;
    font-family: monospace;
    padding: 5px 8px;
    border-radius: 5px;
    user-select: none;
    z-index: 1200;
    pointer-events: none;
    text-transform: uppercase;
  }
  #loading {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 36px; color: #ff3f3f;
    font-weight: 900;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-shadow:
      0 0 15px #ff3f3f,
      0 0 30px #ff3f3f,
      0 0 40px #ff3f3f,
      0 0 60px #ff3f3f;
    letter-spacing: 6px;
    display: none;
    z-index: 1100;
    user-select: none;
  }
  @keyframes wave {
    0%, 100% { text-shadow: 0 0 15px #ff3f3f; }
    50% { text-shadow: 0 0 30px #ff0000, 0 0 40px #ff0000; }
  }
  #loading span {
    display: inline-block;
    animation: wave 1.5s infinite ease-in-out;
  }
  #bloodOverlay {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    pointer-events:none;
    z-index: 1300;
    mix-blend-mode: multiply;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="rotateScreen">PLEASE ROTATE YOUR DEVICE TO LANDSCAPE</div>
<div id="loading"></div>
<canvas id="bloodOverlay"></canvas>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const rotateScreen = document.getElementById('rotateScreen');
  const loading = document.getElementById('loading');
  const bloodCanvas = document.getElementById('bloodOverlay');
  const bloodCtx = bloodCanvas.getContext('2d');

  let W, H;
  let gameStarted = false;
  let gameOver = false;
  let bird;
  let obstacles = [];
  let speed = 2.2;
  let score = 0;
  let difficultyIncrement = 0;
  let maxDifficulty = 3;
  let loadingDuration = 3000;
  let bloodParticles = [];

  function resize() {
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
    bloodCanvas.width = W;
    bloodCanvas.height = H;
  }
  resize();

  function checkOrientation() {
    if(window.innerWidth < window.innerHeight){
      rotateScreen.style.display = "block";
      canvas.style.display = "none";
      bloodCanvas.style.display = "none";
      return false;
    } else {
      rotateScreen.style.display = "none";
      canvas.style.display = "block";
      bloodCanvas.style.display = "block";
      return true;
    }
  }

  class Bird {
    constructor() {
      this.radius = 22;
      this.x = W / 4;
      this.y = H / 2;
      this.velocity = 0;
      this.gravity = 0.25;
      this.lift = -6;
      this.isMoving = false;
      this.dead = false;
    }
    update() {
      if(!this.isMoving) return;
      this.velocity += this.gravity;
      this.velocity *= 0.98;
      this.y += this.velocity;

      if(this.y + this.radius > H){
        this.y = H - this.radius;
        this.velocity = 0;
        this.dead = true;
        gameOver = true;
        createBloodFountain(this.x, this.y);
        shakeScreen();
      }
      if(this.y - this.radius < 0){
        this.y = this.radius;
        this.velocity = 0;
      }
    }
    flap() {
      if(this.dead) return;
      this.velocity += this.lift;
    }
    draw() {
      ctx.save();
      ctx.fillStyle = '#ffff33';
      ctx.shadowColor = 'orange';
      ctx.shadowBlur = 15;
      ctx.beginPath();
      ctx.ellipse(this.x, this.y, this.radius+6, this.radius, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();

      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(this.x + 6, this.y - 6, 6, 0, Math.PI*2);
      ctx.fill();
    }
  }

  class Obstacle {
    constructor(x, width, heightTop, gap) {
      this.x = x;
      this.width = width;
      this.heightTop = heightTop;
      this.gap = gap;
      this.speed = speed;
      this.radius = 14;
      this.bloodDrops = [];
    }

    update() {
      this.x -= this.speed;

      if(this.x + this.width < 0){
        this.x = W + 250 + Math.random()*200;
        let baseHeight = Math.random()*(H - this.gap - 100) + 50;
        this.heightTop = Math.min(baseHeight + difficultyIncrement*20, H - this.gap - 40);
        this.gap = 140 - difficultyIncrement*15;
        if(this.gap < 90) this.gap = 90;
        score++;
        if(score % 5 === 0 && difficultyIncrement < maxDifficulty) difficultyIncrement++;
      }

      if(gameOver && this.x < bird.x + bird.radius && this.x + this.width > bird.x - bird.radius){
        this.spawnBloodDrop();
      }

      for(let i=this.bloodDrops.length-1; i>=0; i--){
        let d = this.bloodDrops[i];
        d.y += d.speed;
        d.opacity -= 0.025;
        if(d.opacity <= 0) this.bloodDrops.splice(i,1);
      }
    }

    spawnBloodDrop() {
      if(this.bloodDrops.length < 8 && Math.random() < 0.3) {
        this.bloodDrops.push({
          x: this.x + this.width/2 + (Math.random()-0.5)*this.width/2,
          y: this.heightTop + this.gap + this.radius,
          speed: 2 + Math.random()*2,
          opacity: 1
        });
      }
    }

    draw() {
      ctx.save();
      ctx.fillStyle = '#8B0000';
      ctx.shadowColor = 'red';
      ctx.shadowBlur = 16;
      roundRect(ctx, this.x, 0, this.width, this.heightTop, this.radius, true);
      roundRect(ctx, this.x, this.heightTop + this.gap, this.width, H - this.heightTop - this.gap, this.radius, true);
      ctx.restore();

      for(let d of this.bloodDrops){
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,0,0,${d.opacity})`;
        ctx.arc(d.x, d.y, 5, 0, Math.PI*2);
        ctx.fill();
      }
    }

    checkCollision(bird) {
      return (
        circleRectCollision(bird.x, bird.y, bird.radius, this.x, 0, this.width, this.heightTop) ||
        circleRectCollision(bird.x, bird.y, bird.radius, this.x, this.heightTop + this.gap, this.width, H - this.heightTop - this.gap)
      );
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill=true) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
    if(fill) ctx.fill();
  }

  function circleRectCollision(cx, cy, cr, rx, ry, rw, rh) {
    let testX = cx;
    let testY = cy;

    if(cx < rx) testX = rx;
    else if(cx > rx + rw) testX = rx + rw;

    if(cy < ry) testY = ry;
    else if(cy > ry + rh) testY = ry + rh;

    let distX = cx - testX;
    let distY = cy - testY;
    let distance = Math.sqrt(distX*distX + distY*distY);

    return distance <= cr;
  }

  function shakeScreen(){
    let intensity = 6;
    let duration = 400;
    let start = performance.now();

    function animate(t){
      let elapsed = t - start;
      if(elapsed < duration){
        let dx = (Math.random()*2-1)*intensity;
        let dy = (Math.random()*2-1)*intensity;
        canvas.style.transform = `translate(${dx}px, ${dy}px)`;
        bloodCanvas.style.transform = `translate(${dx}px, ${dy}px)`;
        requestAnimationFrame(animate);
      } else {
        canvas.style.transform = 'translate(0,0)';
        bloodCanvas.style.transform = 'translate(0,0)';
      }
    }
    requestAnimationFrame(animate);
  }

  class BloodParticle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = 4 + Math.random()*5;
      this.speedX = (Math.random()-0.5)*10;
      this.speedY = - (Math.random()*10 + 10);
      this.gravity = 0.5;
      this.opacity = 1;
      this.fadeSpeed = 0.03 + Math.random()*0.02;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.speedY += this.gravity;
      this.opacity -= this.fadeSpeed;
    }
    draw() {
      bloodCtx.beginPath();
      bloodCtx.fillStyle = `rgba(139,0,0,${this.opacity})`;
      bloodCtx.shadowColor = 'red';
      bloodCtx.shadowBlur = 10;
      bloodCtx.arc(this.x, this.y, this.size, 0, Math.PI*2);
      bloodCtx.fill();
    }
  }

  function createBloodFountain(x, y) {
    bloodParticles.length = 0;
    for(let i=0; i<60; i++){
      bloodParticles.push(new BloodParticle(x, y));
    }
  }

  function updateBloodParticles(){
    bloodCtx.clearRect(0,0,W,H);
    for(let i=bloodParticles.length-1; i>=0; i--){
      let p = bloodParticles[i];
      p.update();
      if(p.opacity <= 0){
        bloodParticles.splice(i,1);
      } else {
        p.draw();
      }
    }
  }

  function showLoadingAnimation(callback) {
    loading.style.display = 'block';
    loading.innerHTML = ''; 
    const text = 'LOADING';
    for(let i=0; i<text.length; i++){
      let span = document.createElement('span');
      span.textContent = text[i];
      span.style.animationDelay = `${i * 0.15}s`;
      loading.appendChild(span);
    }
    setTimeout(() => {
      loading.style.display = 'none';
      callback();
    }, loadingDuration);
  }

  function startGame(){
    bird = new Bird();
    bird.isMoving = true; // فقط این خط اضافه شده
    obstacles = [];
    bloodParticles.length = 0;
    gameStarted = true;
    gameOver = false;
    score = 0;
    difficultyIncrement = 0;
    speed = 2.2;

    let startX = W + 200;
    for(let i=0; i<4; i++){
      let gapSize = 140;
      let hTop = Math.random()*(H - gapSize - 100) + 50;
      obstacles.push(new Obstacle(startX + i*250, 60, hTop, gapSize));
    }
  }

  function gameLoop(){
    ctx.clearRect(0,0,W,H);

    obstacles.forEach(ob => {
      ob.update();
      ob.draw();
      if(ob.checkCollision(bird) && !bird.dead){
        bird.dead = true;
        gameOver = true;
        createBloodFountain(bird.x, bird.y);
        shakeScreen();
      }
    });

    bird.update();
    bird.draw();

    if(gameOver){
      updateBloodParticles();
    }

    if(!gameOver && gameStarted){
      requestAnimationFrame(gameLoop);
    } else if(gameOver){
      setTimeout(() => {
        gameStarted = false;
        showLoadingAnimation(() => {
          startGame();
          gameLoop();
        });
      }, 2500);
    }
  }

  let orientationChanged = false;
  window.addEventListener('resize', () => {
    resize();
    if(checkOrientation() && !orientationChanged){
      orientationChanged = true;
      showLoadingAnimation(() => {
        startGame();
        gameLoop();
      });
    }
  });

  if(checkOrientation()){
    orientationChanged = true;
    showLoadingAnimation(() => {
      startGame();
      gameLoop();
    });
  }

  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if(!bird.dead && gameStarted){
      bird.flap();
    }
  });

  canvas.addEventListener('mousedown', e => {
    if(!bird.dead && gameStarted){
      bird.flap();
    }
  });
</script>

</body>
</html>
