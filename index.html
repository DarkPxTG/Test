<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Flappy Bird Pro</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw;
    background: #000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  #gameCanvas {
    display: block;
    background: url('https://s6.uupload.ir/files/28ba5059824647.5a309e5d410de_3m3r.jpg') no-repeat center center;
    background-size: cover;
    width: 100vw;
    height: 100vh;
    touch-action: none;
    position: relative;
    z-index: 1;
  }
  #loadingScreen {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1500;
    overflow: hidden;
  }
  #loadingLogo {
    width: 100px; height: 100px; /* کوچکتر برای بارگذاری سریع‌تر */
    animation: dynamicLogo 1.5s ease-in-out infinite;
  }
  @keyframes dynamicLogo {
    0% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
    100% { transform: translateY(0); }
  }
  #loadingText {
    color: #ff3f3f;
    font-size: 30px; /* کوچکتر برای عملکرد بهتر */
    font-weight: 900;
    text-shadow: 0 0 10px #ff3f3f;
    margin-top: 15px;
    letter-spacing: 3px;
  }
  #loadingText span {
    display: inline-block;
    animation: bounce 0.8s infinite ease-in-out;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  #particleCanvas {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1499;
  }
  #homeScreen {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: url('https://s6.uupload.ir/files/28ba5059824647.5a309e5d410de_3m3r.jpg') no-repeat center center;
    background-size: cover;
    display: none;
    z-index: 1100;
    text-align: center;
    overflow: hidden;
  }
  #homeScreen::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.8));
    z-index: 1;
  }
  #homeScreenContent {
    position: relative;
    z-index: 2;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #gameTitle {
    font-size: 40px;
    color: #ffffff;
    font-weight: 900;
    text-shadow: 0 0 10px #ff3f3f;
    margin-bottom: 25px;
    animation: titlePulse 2s ease-in-out infinite;
  }
  @keyframes titlePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  #startButton {
    background: linear-gradient(45deg, #ff3f3f, #ff0000);
    color: #ffffff;
    font-size: 24px; font-weight: 700;
    padding: 12px 35px;
    border-radius: 10px;
    border: 2px solid #ffffff;
    cursor: pointer;
    text-shadow: 0 0 5px #000000;
    box-shadow: 0 0 15px rgba(255, 63, 63, 0.8);
    transition: transform 0.2s;
    z-index: 3;
  }
  #startButton:hover {
    transform: scale(1.1);
  }
  #floatingBird {
    position: absolute;
    top: 15%;
    left: 15%;
    width: 70px; height: 70px;
    animation: floatBird 4s ease-in-out infinite;
    z-index: 2;
  }
  @keyframes floatBird {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }
  #loading {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 30px; color: #ff3f3f;
    font-weight: 900;
    text-shadow: 0 0 10px #ff3f3f;
    letter-spacing: 5px;
    display: none;
    z-index: 1100;
    user-select: none;
  }
  #loading span {
    display: inline-block;
    animation: wave 1.2s infinite ease-in-out;
  }
  @keyframes wave {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  #bloodOverlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: 1300;
    mix-blend-mode: multiply;
  }
  #leaderboardButton, #settingsButton {
    position: absolute;
    background: none; border: none;
    font-size: 24px; color: #ffffff;
    cursor: pointer; z-index: 3;
    text-shadow: 0 0 10px #ff3f3f;
  }
  #leaderboardButton {
    top: 15px; left: 15px;
  }
  #settingsButton {
    top: 55px; left: 15px;
  }
  #leaderboardButton:hover, #settingsButton:hover {
    transform: scale(1.2);
  }
  #leaderboard, #settingsMenu {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #ff3f3f;
    z-index: 1200;
    display: none;
    text-align: center;
    width: 80%; max-width: 300px;
  }
  #leaderboard h2, #settingsMenu h2 {
    font-size: 24px;
    margin: 0 0 12px;
    text-shadow: 0 0 10px #ff3f3f;
  }
  #leaderboard p, #settingsMenu p {
    font-size: 16px;
    margin: 5px 0;
  }
  #leaderboard button, #settingsMenu button {
    background: linear-gradient(45deg, #ff3f3f, #ff0000);
    color: #ffffff;
    font-size: 14px;
    padding: 6px 14px;
    border-radius: 6px;
    border: 2px solid #ffffff;
    cursor: pointer;
    margin: 5px;
  }
  #leaderboard button:hover, #settingsMenu button:hover {
    transform: scale(1.1);
  }
  #settingsMenu .slider-container {
    margin: 8px 0;
  }
  #settingsMenu input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    background: #333;
    border-radius: 5px;
    height: 6px;
    outline: none;
  }
  #settingsMenu input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px; height: 18px;
    background: #ff3f3f;
    border: 2px solid #ffffff;
    border-radius: 50%;
    cursor: pointer;
  }
  #settingsMenu input[type="range"]::-moz-range-thumb {
    width: 18px; height: 18px;
    background: #ff3f3f;
    border: 2px solid #ffffff;
    border-radius: 50%;
    cursor: pointer;
  }
  #settingsMenu .slider-value {
    font-size: 12px;
    color: #ffffff;
    margin-top: 5px;
  }
  #settingsMenu .button-container {
    display: flex;
    justify-content: center;
    gap: 8px;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="loadingScreen">
  <canvas id="particleCanvas"></canvas>
  <img id="loadingLogo" src="https://s6.uupload.ir/files/a-vibrant-blue-and-yellow-bird-in-mid-flight-cut-out-stock-png_ohfh.png" alt="Loading Logo" loading="lazy" />
  <div id="loadingText">LOADING</div>
</div>
<div id="homeScreen">
  <div id="homeScreenContent">
    <button id="leaderboardButton">☰</button>
    <button id="settingsButton" title="Settings">⚙️</button>
    <div id="gameTitle">Flappy Bird Pro</div>
    <button id="startButton">Start Game</button>
    <img id="floatingBird" src="https://s6.uupload.ir/files/a-vibrant-blue-and-yellow-bird-in-mid-flight-cut-out-stock-png_ohfh.png" alt="Floating Bird" loading="lazy" />
  </div>
</div>
<div id="loading"></div>
<canvas id="bloodOverlay"></canvas>
<div id="leaderboard">
  <h2>Leaderboard</h2>
  <p id="currentScore">Current Score: 0</p>
  <p id="highScore">High Score: 0</p>
  <button id="closeLeaderboard">Close</button>
</div>
<div id="settingsMenu">
  <h2>Settings</h2>
  <div class="slider-container">
    <p>Bird Speed</p>
    <input type="range" id="birdSpeed" min="1.5" max="3.5" step="0.5" value="2.5">
    <div class="slider-value" id="birdSpeedValue">Normal</div>
  </div>
  <div class="slider-container">
    <p>Fall/Fly Speed</p>
    <input type="range" id="fallFlySpeed" min="0" max="2" step="1" value="1">
    <div class="slider-value" id="fallFlySpeedValue">Normal</div>
  </div>
  <div class="slider-container">
    <p>Game Difficulty</p>
    <input type="range" id="gameDifficulty" min="0" max="4" step="1" value="2">
    <div class="slider-value" id="gameDifficultyValue">Normal</div>
  </div>
  <div class="button-container">
    <button id="resetSettings">Reset</button>
    <button id="closeSettings">Close</button>
  </div>
</div>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const loadingScreen = document.getElementById('loadingScreen');
  const particleCanvas = document.getElementById('particleCanvas');
  const particleCtx = particleCanvas.getContext('2d');
  const homeScreen = document.getElementById('homeScreen');
  const startButton = document.getElementById('startButton');
  const loading = document.getElementById('loading');
  const bloodCanvas = document.getElementById('bloodOverlay');
  const bloodCtx = bloodCanvas.getContext('2d');
  const leaderboardButton = document.getElementById('leaderboardButton');
  const settingsButton = document.getElementById('settingsButton');
  const leaderboard = document.getElementById('leaderboard');
  const closeLeaderboard = document.getElementById('closeLeaderboard');
  const settingsMenu = document.getElementById('settingsMenu');
  const closeSettings = document.getElementById('closeSettings');
  const resetSettings = document.getElementById('resetSettings');
  const birdSpeedSlider = document.getElementById('birdSpeed');
  const fallFlySpeedSlider = document.getElementById('fallFlySpeed');
  const gameDifficultySlider = document.getElementById('gameDifficulty');
  const birdSpeedValue = document.getElementById('birdSpeedValue');
  const fallFlySpeedValue = document.getElementById('fallFlySpeedValue');
  const gameDifficultyValue = document.getElementById('gameDifficultyValue');
  const currentScoreDisplay = document.getElementById('currentScore');
  const highScoreDisplay = document.getElementById('highScore');

  let W, H;
  let gameStarted = false;
  let gameOver = false;
  let bird;
  let obstacles = [];
  let speed = 2.5;
  let score = 0;
  let highScore = localStorage.getItem('highScore') ? parseInt(localStorage.getItem('highScore')) : 0;
  let difficultyIncrement = 0;
  let maxDifficulty = 3;
  let minGap = 80;
  let loadingDuration = 3000; // 3 ثانیه
  let bloodParticles = [];
  let birdImage = new Image();
  birdImage.src = 'https://s6.uupload.ir/files/a-vibrant-blue-and-yellow-bird-in-mid-flight-cut-out-stock-png_ohfh.png';
  let startTime = 0;
  let inHomeScreen = false;
  let isGameActive = false;

  // ذرات برای لودینگ (کاهش تعداد به 20)
  let particles = [];
  class Particle {
    constructor() {
      this.x = Math.random() * particleCanvas.width;
      this.y = Math.random() * particleCanvas.height;
      this.size = Math.random() * 4 + 1;
      this.speedX = (Math.random() * 1.5 - 0.75);
      this.speedY = (Math.random() * 1.5 - 0.75);
      this.opacity = Math.random() * 0.4 + 0.3;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.opacity -= 0.01;
      if (this.x < 0 || this.x > particleCanvas.width) this.speedX *= -1;
      if (this.y < 0 || this.y > particleCanvas.height) this.speedY *= -1;
      if (this.opacity <= 0) {
        this.x = Math.random() * particleCanvas.width;
        this.y = Math.random() * particleCanvas.height;
        this.opacity = Math.random() * 0.4 + 0.3;
      }
    }
    draw() {
      particleCtx.beginPath();
      particleCtx.fillStyle = `rgba(255, 63, 63, ${this.opacity})`;
      particleCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      particleCtx.fill();
    }
  }

  function initParticles() {
    particles = [];
    for (let i = 0; i < 20; i++) {
      particles.push(new Particle());
    }
  }

  function animateParticles() {
    particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
    particles.forEach(p => {
      p.update();
      p.draw();
    });
    if (loadingScreen.style.display !== 'none') {
      requestAnimationFrame(animateParticles);
    }
  }

  const defaultSettings = {
    birdSpeed: 2.5,
    fallFlySpeed: 1,
    gameDifficulty: 2
  };

  let settings = JSON.parse(localStorage.getItem('flappyBirdSettings')) || defaultSettings;
  applySettings();

  function applySettings() {
    speed = parseFloat(settings.birdSpeed);
    birdSpeedSlider.value = speed;
    birdSpeedValue.textContent = speed === 1.5 ? 'Slow' : speed === 2.5 ? 'Normal' : 'Fast';

    if (bird) {
      switch (parseInt(settings.fallFlySpeed)) {
        case 0:
          bird.gravity = 0.2;
          bird.lift = -5;
          fallFlySpeedValue.textContent = 'Slow';
          break;
        case 1:
          bird.gravity = 0.3;
          bird.lift = -6;
          fallFlySpeedValue.textContent = 'Normal';
          break;
        case 2:
          bird.gravity = 0.4;
          bird.lift = -7;
          fallFlySpeedValue.textContent = 'Fast';
          break;
      }
    }
    fallFlySpeedSlider.value = settings.fallFlySpeed;

    switch (parseInt(settings.gameDifficulty)) {
      case 0:
        maxDifficulty = 1;
        minGap = 100;
        gameDifficultyValue.textContent = 'Very Easy';
        break;
      case 1:
        maxDifficulty = 2;
        minGap = 90;
        gameDifficultyValue.textContent = 'Easy';
        break;
      case 2:
        maxDifficulty = 3;
        minGap = 80;
        gameDifficultyValue.textContent = 'Normal';
        break;
      case 3:
        maxDifficulty = 4;
        minGap = 70;
        gameDifficultyValue.textContent = 'Hard';
        break;
      case 4:
        maxDifficulty = 5;
        minGap = 60;
        gameDifficultyValue.textContent = 'Very Hard';
        break;
    }
    gameDifficultySlider.value = settings.gameDifficulty;

    localStorage.setItem('flappyBirdSettings', JSON.stringify(settings));
  }

  function resetSettingsToDefault() {
    settings = { ...defaultSettings };
    applySettings();
  }

  function resize() {
    W = window.innerWidth;
    H = window.innerHeight;
    // اطمینان از جهت افقی: عرض بیشتر از ارتفاع
    if (W < H) {
      W = window.innerHeight;
      H = window.innerWidth;
    }
    canvas.width = W;
    canvas.height = H;
    bloodCanvas.width = W;
    bloodCanvas.height = H;
    particleCanvas.width = W;
    particleCanvas.height = H;
    initParticles();
  }
  resize();

  window.addEventListener('load', () => {
    loadingScreen.style.display = 'flex';
    const text = 'LOADING';
    const loadingText = document.getElementById('loadingText');
    loadingText.innerHTML = '';
    for (let i = 0; i < text.length; i++) {
      let span = document.createElement('span');
      span.textContent = text[i];
      span.style.animationDelay = `${i * 0.1}s`;
      loadingText.appendChild(span);
    }
    initParticles();
    animateParticles();
    setTimeout(() => {
      loadingScreen.style.display = 'none';
      homeScreen.style.display = 'block';
      inHomeScreen = true;
    }, 3000); // 3 ثانیه
  });

  class Bird {
    constructor() {
      this.radius = 25;
      this.x = W / 4;
      this.y = H / 2;
      this.velocity = 0;
      this.gravity = 0.3;
      this.lift = -6;
      this.isMoving = false;
      this.dead = false;
      applySettings();
    }
    update() {
      if (!this.isMoving) return;
      this.velocity += this.gravity;
      this.velocity *= 0.95;
      this.y += this.velocity;

      if (this.y + this.radius > H) {
        this.y = H - this.radius;
        this.velocity = 0;
        this.dead = true;
        gameOver = true;
        createBloodFountain(this.x, this.y);
        shakeScreen();
      }
      if (this.y - this.radius < 0) {
        this.y = this.radius;
        this.velocity = 0;
      }
    }
    flap() {
      if (this.dead) return;
      this.velocity += this.lift;
      if (!isGameActive) {
        isGameActive = true;
        this.isMoving = true;
        obstacles.forEach(ob => ob.isMoving = true);
      }
    }
    draw() {
      ctx.save();
      ctx.shadowColor = 'orange';
      ctx.shadowBlur = 10;
      if (birdImage.complete) {
        ctx.drawImage(birdImage, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
      } else {
        ctx.fillStyle = '#ffff33';
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, this.radius, this.radius, 0, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.restore();
    }
  }

  class Obstacle {
    constructor(x, heightTop, gap) {
      this.x = x;
      this.width = 50;
      this.heightTop = heightTop;
      this.gap = gap;
      this.speed = speed + (Math.random() * 0.3 - 0.15);
      this.radius = 12;
      this.bloodDrops = [];
      this.isMoving = false;
    }
    update() {
      if (!this.isMoving) return;
      this.x -= this.speed;

      if (this.x + this.width < 0) {
        this.x = W + 400 + Math.random() * 200;
        let baseHeight = Math.random() * (H - this.gap - 100) + 50;
        this.heightTop = Math.min(baseHeight + difficultyIncrement * 10, H - this.gap - 40);
        this.gap = Math.max(minGap, 120 - difficultyIncrement * 5);
        this.speed = Math.min(4, speed + difficultyIncrement * 0.2);
        score++;
        if (score % 3 === 0 && difficultyIncrement < maxDifficulty) difficultyIncrement += 0.5;
      }

      if (gameOver && this.x < bird.x + bird.radius && this.x + this.width > bird.x - bird.radius) {
        this.spawnBloodDrop();
      }

      for (let i = this.bloodDrops.length - 1; i >= 0; i--) {
        let d = this.bloodDrops[i];
        d.y += d.speed;
        d.opacity -= 0.025;
        if (d.opacity <= 0) this.bloodDrops.splice(i, 1);
      }
    }
    spawnBloodDrop() {
      if (this.bloodDrops.length < 8 && Math.random() < 0.3) {
        this.bloodDrops.push({
          x: this.x + this.width / 2 + (Math.random() - 0.5) * this.width / 2,
          y: this.heightTop + this.gap + this.radius,
          speed: 2 + Math.random() * 2,
          opacity: 1
        });
      }
    }
    draw() {
      ctx.save();
      ctx.fillStyle = '#8B0000';
      ctx.shadowColor = 'red';
      ctx.shadowBlur = 12;
      roundRect(ctx, this.x, 0, this.width, this.heightTop, this.radius, true);
      roundRect(ctx, this.x, this.heightTop + this.gap, this.width, H - this.heightTop - this.gap, this.radius, true);
      ctx.restore();

      for (let d of this.bloodDrops) {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,0,0,${d.opacity})`;
        ctx.arc(d.x, d.y, 4, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    checkCollision(bird) {
      return (
        circleRectCollision(bird.x, bird.y, bird.radius, this.x, 0, this.width, this.heightTop) ||
        circleRectCollision(bird.x, bird.y, bird.radius, this.x, this.heightTop + this.gap, this.width, H - this.heightTop - this.gap)
      );
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill = true) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
    if (fill) ctx.fill();
  }

  function circleRectCollision(cx, cy, cr, rx, ry, rw, rh) {
    let testX = cx;
    let testY = cy;
    if (cx < rx) testX = rx;
    else if (cx > rx + rw) testX = rx + rw;
    if (cy < ry) testY = ry;
    else if (cy > ry + rh) testY = ry + rh;
    let distX = cx - testX;
    let distY = cy - testY;
    return Math.sqrt(distX * distX + distY * distY) <= cr;
  }

  function shakeScreen() {
    let intensity = 5;
    let duration = 300;
    let start = performance.now();
    function animate(t) {
      let elapsed = t - start;
      if (elapsed < duration) {
        let dx = (Math.random() * 2 - 1) * intensity;
        let dy = (Math.random() * 2 - 1) * intensity;
        canvas.style.transform = `translate(${dx}px, ${dy}px)`;
        bloodCanvas.style.transform = `translate(${dx}px, ${dy}px)`;
        requestAnimationFrame(animate);
      } else {
        canvas.style.transform = 'translate(0,0)';
        bloodCanvas.style.transform = 'translate(0,0)';
      }
    }
    requestAnimationFrame(animate);
  }

  class BloodParticle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = 3 + Math.random() * 4;
      this.speedX = (Math.random() - 0.5) * 8;
      this.speedY = -(Math.random() * 8 + 8);
      this.gravity = 0.4;
      this.opacity = 1;
      this.fadeSpeed = 0.02 + Math.random() * 0.01;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.speedY += this.gravity;
      this.opacity -= this.fadeSpeed;
    }
    draw() {
      bloodCtx.beginPath();
      bloodCtx.fillStyle = `rgba(139,0,0,${this.opacity})`;
      bloodCtx.shadowColor = 'red';
      bloodCtx.shadowBlur = 8;
      bloodCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      bloodCtx.fill();
    }
  }

  function createBloodFountain(x, y) {
    for (let i = 0; i < 50; i++) {
      bloodParticles.push(new BloodParticle(x, y));
    }
  }

  function updateBloodParticles() {
    bloodCtx.clearRect(0, 0, W, H);
    for (let i = bloodParticles.length - 1; i >= 0; i--) {
      let p = bloodParticles[i];
      p.update();
      if (p.opacity <= 0) {
        bloodParticles.splice(i, 1);
      } else {
        p.draw();
      }
    }
  }

  function drawTimer() {
    if (!gameStarted || gameOver || !isGameActive) return;
    const elapsedTime = Math.floor((performance.now() - startTime) / 1000);
    ctx.save();
    ctx.fillStyle = '#ffffff';
    ctx.font = '30px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${elapsedTime}s`, W / 2, 25);
    ctx.restore();
    return elapsedTime;
  }

  function showLoadingAnimation(callback) {
    loading.style.display = 'block';
    loading.innerHTML = '';
    const text = 'LOADING';
    for (let i = 0; i < text.length; i++) {
      let span = document.createElement('span');
      span.textContent = text[i];
      span.style.animationDelay = `${i * 0.1}s`;
      loading.appendChild(span);
    }
    setTimeout(() => {
      loading.style.display = 'none';
      callback();
    }, loadingDuration);
  }

  function updateLeaderboard() {
    currentScoreDisplay.textContent = `Current Score: ${score}`;
    highScoreDisplay.textContent = `High Score: ${highScore}`;
  }

  function startGame() {
    bird = new Bird();
    obstacles = [];
    bloodParticles = [];
    gameStarted = true;
    gameOver = false;
    score = 0;
    difficultyIncrement = 0;
    startTime = performance.now();
    homeScreen.style.display = 'none';
    leaderboard.style.display = 'none';
    settingsMenu.style.display = 'none';
    inHomeScreen = false;
    isGameActive = false;

    let startX = W + 400;
    for (let i = 0; i < 4; i++) {
      let gapSize = 120;
      let hTop = Math.random() * (H - gapSize - 100) + 50;
      obstacles.push(new Obstacle(startX + i * 400, hTop, gapSize));
    }
    updateLeaderboard();
  }

  function gameLoop() {
    ctx.clearRect(0, 0, W, H);

    const elapsedTime = drawTimer();
    if (elapsedTime >= 20 && difficultyIncrement < maxDifficulty) {
      difficultyIncrement = Math.min(maxDifficulty, difficultyIncrement + (elapsedTime - 20) * 0.02);
    }

    obstacles.forEach(ob => {
      ob.update();
      ob.draw();
      if (ob.checkCollision(bird) && !bird.dead) {
        bird.dead = true;
        gameOver = true;
        createBloodFountain(bird.x, this.y);
        shakeScreen();
      }
    });

    bird.update();
    bird.draw();

    if (gameOver) {
      updateBloodParticles();
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
        updateLeaderboard();
      }
    }

    if (!gameOver && gameStarted) {
      requestAnimationFrame(gameLoop);
    } else if (gameOver) {
      setTimeout(() => {
        gameStarted = false;
        bloodParticles = [];
        bloodCtx.clearRect(0, 0, W, H);
        showLoadingAnimation(() => {
          homeScreen.style.display = 'block';
          inHomeScreen = true;
          updateLeaderboard();
        });
      }, 2000);
    }
  }

  startButton.addEventListener('click', () => {
    if (inHomeScreen) {
      startGame();
      gameLoop();
    }
  });

  startButton.addEventListener('touchstart', e => {
    e.preventDefault();
    if (inHomeScreen) {
      startGame();
      gameLoop();
    }
  });

  leaderboardButton.addEventListener('click', () => {
    if (inHomeScreen) {
      leaderboard.style.display = 'block';
      updateLeaderboard();
    }
  });

  leaderboardButton.addEventListener('touchstart', e => {
    e.preventDefault();
    if (inHomeScreen) {
      leaderboard.style.display = 'block';
      updateLeaderboard();
    }
  });

  settingsButton.addEventListener('click', () => {
    if (inHomeScreen) {
      settingsMenu.style.display = 'block';
    }
  });

  settingsButton.addEventListener('touchstart', e => {
    e.preventDefault();
    if (inHomeScreen) {
      settingsMenu.style.display = 'block';
    }
  });

  closeLeaderboard.addEventListener('click', () => {
    leaderboard.style.display = 'none';
  });

  closeLeaderboard.addEventListener('touchstart', e => {
    e.preventDefault();
    leaderboard.style.display = 'none';
  });

  closeSettings.addEventListener('click', () => {
    settingsMenu.style.display = 'none';
  });

  closeSettings.addEventListener('touchstart', e => {
    e.preventDefault();
    settingsMenu.style.display = 'none';
  });

  resetSettings.addEventListener('click', () => {
    resetSettingsToDefault();
  });

  resetSettings.addEventListener('touchstart', e => {
    e.preventDefault();
    resetSettingsToDefault();
  });

  birdSpeedSlider.addEventListener('input', () => {
    settings.birdSpeed = parseFloat(birdSpeedSlider.value);
    applySettings();
  });

  fallFlySpeedSlider.addEventListener('input', () => {
    settings.fallFlySpeed = parseInt(fallFlySpeedSlider.value);
    applySettings();
  });

  gameDifficultySlider.addEventListener('input', () => {
    settings.gameDifficulty = parseInt(gameDifficultySlider.value);
    applySettings();
  });

  window.addEventListener('resize', () => {
    resize();
  });

  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if (!bird.dead && gameStarted) {
      bird.flap();
    }
  });

  canvas.addEventListener('mousedown', e => {
    if (!bird.dead && gameStarted) {
      bird.flap();
    }
  });
</script>

</body>
</html>
